\documentclass[a4paper,12pt,book]{memoir}

% comment this if don't want to show answer
\def\withanswer{1}

% Turn on subsection numbering in memoir class
\setsecnumdepth{subsection}

% For epigraphs
\usepackage{epigraph}

% Use varwidth to make epigraph length adaptive
\usepackage{varwidth}
\renewcommand{\epigraphsize}{\normalsize}
\setlength{\epigraphwidth}{0.8\textwidth}
\renewcommand{\textflush}{flushright}
\renewcommand{\sourceflush}{flushright}
% A useful addition
\newcommand{\epitextfont}{\kai}
\newcommand{\episourcefont}{\kai}

\makeatletter
\newsavebox{\epi@textbox}
\newsavebox{\epi@sourcebox}
\newlength\epi@finalwidth
\renewcommand{\epigraph}[2]{%
  \vspace{\beforeepigraphskip}
  {\epigraphsize\begin{\epigraphflush}
   \epi@finalwidth=\z@
   \sbox\epi@textbox{%
     \varwidth{\epigraphwidth}
     \begin{\textflush}\epitextfont#1\end{\textflush}
     \endvarwidth
   }%
   \epi@finalwidth=\wd\epi@textbox
   \sbox\epi@sourcebox{%
     \varwidth{\epigraphwidth}
     \begin{\sourceflush}\episourcefont#2\end{\sourceflush}%
     \endvarwidth
   }%
   \ifdim\wd\epi@sourcebox>\epi@finalwidth 
     \epi@finalwidth=\wd\epi@sourcebox
   \fi
   \leavevmode\vbox{
     \hb@xt@\epi@finalwidth{\hfil\box\epi@textbox}
     \vskip1.75ex
     \hrule height \epigraphrule
     \vskip.75ex
     \hb@xt@\epi@finalwidth{\hfil\box\epi@sourcebox}
   }%
   \end{\epigraphflush}
   \vspace{\afterepigraphskip}}}
\makeatother

%%% check mark and x mark
\usepackage{pifont}% http://ctan.org/pkg/pifont
\newcommand{\cmark}{\ding{51}}%
% \newcommand{\xmark}{\ding{55}}%
\newcommand{\xmark}{\times}

\newcommand*\numcircled[1]{\raisebox{.5pt}{\textcircled{\raisebox{-.9pt} {#1}}}}


\usepackage[xetex,
            bookmarksnumbered=true,
            bookmarksopen=true,
            colorlinks=false,
            pdfborder={0 0 1},
            citecolor=blue,
            linkcolor=red,
            anchorcolor=green,
            urlcolor=blue,
            breaklinks=true,
            naturalnames  %与algorithm2e宏包协调
            ]{hyperref}

% For Chinese fonts
% \usepackage{fontspec}
% \setmainfont{SimSun}
\usepackage[AutoFakeBold,SlantFont]{xeCJK}
% \usepackage[SlantFont]{xeCJK}   %AutoFakeBold=true makes CJK characters in the generated PDF can't be copied

\setCJKmainfont{SimSun}

\usepackage{multirow}
\usepackage{ulem}               % Fro \sout
\usepackage[usenames,dvipsnames]{pstricks}
\usepackage{pstricks-add}  % For \psrotate, \psbrace
\usepackage{epsfig}
\usepackage{pst-grad} % For gradients
\usepackage{pst-plot} % For axes
\usepackage{pst-node} % For nodes
\usepackage[space]{grffile} % For spaces in paths
\usepackage{etoolbox} % For spaces in paths
\AtBeginEnvironment{quote}{\kai\small} %for quote environment
\AtBeginEnvironment{quotation}{\kai\small} %for quotation environment

\usepackage{pst-eucl}

\usepackage[english]{babel}     % For enquote
\usepackage{csquotes} 

\usepackage{colortbl}
\usepackage{booktabs}       % 表格，横的粗线；\specialrule{1pt}{0pt}{0pt}

\usepackage{tikz,fp}
% \usetikzlibrary{angles}         % for perpendicular symbols
\usetikzlibrary{calc,intersections,patterns,angles,quotes}           %
\usepackage{tikz-3dplot}
\usetikzlibrary{3d}

\usepackage{tkz-euclide} % for perpendicular symbols, \tkzMarkRightAngle, \tkzDefPoint
\usetkzobj{all}

\makeatletter
\def\calcLength(#1,#2)#3{%
  \pgfpointdiff{\pgfpointanchor{#1}{center}}%
               {\pgfpointanchor{#2}{center}}%
  \pgf@xa=\pgf@x%
  \pgf@ya=\pgf@y%
  \FPeval\@temp@a{\pgfmath@tonumber{\pgf@xa}}%
  \FPeval\@temp@b{\pgfmath@tonumber{\pgf@ya}}%
  \FPeval\@temp@sum{(\@temp@a*\@temp@a+\@temp@b*\@temp@b)}%
  \FProot{\FPMathLen}{\@temp@sum}{2}%
  \FPround\FPMathLen\FPMathLen5\relax
  \global\expandafter\edef\csname #3\endcsname{\FPMathLen}
}

\def\drawArc(#1,#2,#3){%
  \pgfmathanglebetweenpoints{\pgfpointanchor{#1}{center}}{\pgfpointanchor{#2}{center}}
  \let\StartAngle\pgfmathresult
  \pgfmathanglebetweenpoints{\pgfpointanchor{#1}{center}}{\pgfpointanchor{#3}{center}}
  \let\EndAngle\pgfmathresult
  \calcLength(#1,#2){myr@dius}
  \draw (#2) arc[start angle=\StartAngle, end angle=\EndAngle, radius=\myr@dius pt];
}

% tikz command to draw arc with center
\def\centerarc[#1](#2)(#3:#4:#5)% Syntax: [draw options] (center) (initial angle:final angle:radius)
{ \draw[#1] ($(#2)+({#5*cos(#3)},{#5*sin(#3)})$) arc (#3:#4:#5); }
\makeatother

\usepackage{pgfplots}
\pgfplotsset{compat=1.8}

\makeatletter % For spaces in paths
    \patchcmd\Gread@eps{\@inputcheck#1 }{\@inputcheck"#1"\relax}{}{}

    % Font of theorem subtitle
    \def\th@plain{%
      \thm@notefont{}% same as heading font
      \kai % body font
    }
    \def\th@definition{%
      \thm@notefont{}% same as heading font
      \bfseries \kai % body font
    }
\makeatother

\def\answer#1{
  \ifx\withanswer\undefined\else 提示：\par\nopagebreak #1\fi
}

\usepackage{mathtools,amsthm,amsfonts,amssymb,bm}
\usepackage{extarrows}          % for xlongequal
% use `fc-list|grep -i kai' to get installed font list
\setCJKfamilyfont{kai}{KaiTi}
\setCJKmonofont{NSimSun}
\newcommand{\kai}{\CJKfamily{kai}}

%% chapter style
% \usepackage{titlesec, blindtext, color}
% \definecolor{gray75}{gray}{0.75}
% \newcommand{\hsp}{\hspace{20pt}}
% \titleformat{\chapter}[hang]{\Huge\bfseries}{\thechapter\hsp\textcolor{gray75}{|}\hsp}{0pt}{\Huge\bfseries}
\makechapterstyle{box}{
  \renewcommand*{\printchaptername}{}
  \renewcommand*{\chapnumfont}{\normalfont\sffamily\huge\bfseries}
  \renewcommand*{\printchapternum}{
    \flushright
    \begin{tikzpicture}
      \draw[fill,color=black!30] (0,0) rectangle (2cm,2cm);
      \draw[color=white] (1cm,1cm) node { \chapnumfont\thechapter };
    \end{tikzpicture}
  }
  \renewcommand*{\chaptitlefont}{\normalfont\sffamily\Huge\bfseries}
  \renewcommand*{\printchaptertitle}[1]{\flushright\chaptitlefont##1}
}
\chapterstyle{box}
%% This won't work with the `babel' package
% \renewcommand\chaptername{第~\thechapter~章}
%% We have to use the following fix
\addto\captionsenglish{%
  % \renewcommand\chaptername{第~\thechapter~章}
  \renewcommand\chaptername{}
  \renewcommand\contentsname{目~~~~录}
}

% % patch \newtheoremstyle to accept \newline<other tokens>
% \makeatletter
% \patchcmd{\newtheoremstyle}
%  {\def\@tempb{\newline}}
%  {\def\@tempb{\newline}\edef\@tempa{\unexpanded\expandafter{\@car#8\@nil}}}
%  {}{}
% \patchcmd{\newtheoremstyle}
%  {\def\thmheadnl{\newline}}
%  {\def\thmheadnl{#8}}
%  {}{}
% \makeatother

\newtheoremstyle{break}% name
  {15pt}%      Space above, empty = `usual value'
  {}%          Space below
  {\kai}%     Body font
  {}%         Indent amount (empty = no indent, \parindent = para indent)
  {\bfseries}% Thm head font
  {.}%        Punctuation after thm head
  %{\newline\hspace*{\parindent}}% Space after thm head: \newline = linebreak
  {5pt plus 1pt minus 1pt}% Space after thm head: \newline = linebreak
  {}%         Thm head spec
\theoremstyle{break}
\newtheorem{theorem}{\kai 定理}[section]
\newtheorem{example}[theorem]{\kai 例} % Use the same counter as theorem
\newtheorem{property}[theorem]{\kai 性质} % Use the same counter as theorem
\newtheorem{question}[theorem]{\kai 题} % Use the same counter as theorem
\newtheorem{definition}[theorem]{\kai 定义} % Use the same counter as theorem
\newtheorem{corollary}{\kai 推论}[theorem]  % Reset after every theorem
\newtheorem{lemma}[theorem]{\kai 引理}  % Use the same counter as theorem
% \renewcommand*{\proofname}{证明}
\newcommand{\note}{\begingroup\bfseries\kai 注：\endgroup}
\newcommand{\think}{\begingroup\bfseries\kai 思考：\endgroup}
\newcommand{\hints}{\begingroup\bfseries\kai 提示：\endgroup}

\newcommand{\kurschak}{K\"ursch\'ak}
\newcommand{\term}[1]{\begingroup\bfseries\kai{#1}\endgroup}

\DeclareMathOperator{\atan}{atan}

% w/o using the babel package
% \renewcommand{\figurename}{\kai 图}
% w/ babel packge and English as language
\addto\captionsenglish{\renewcommand{\figurename}{\kai 图}}

% Change colon(:) in figure caption to period(.)
\usepackage{caption}
\captionsetup{labelsep=period}

\newcommand{\norm}[1]{\left\lVert{#1}\right\rVert}
\renewcommand*{\vec}[1]{\mathbf{#1}}
\renewcommand*{\le}{\leqslant}
\renewcommand*{\ge}{\geqslant}
\renewcommand*\labelenumi{(\theenumi)}

% Make proof environemtn skip the first line
\makeatletter
\renewenvironment{proof}[1][证明]{\par
  \pushQED{\qed}%
  \normalfont \topsep6\p@\@plus6\p@\relax
  \trivlist
  \item[\hskip\labelsep
    \bfseries \kai%\itshape
    #1\@addpunct{.}]%\mbox{}\\*% new line after \proofname
}{%
  \popQED\endtrivlist\@endpefalse
}
\makeatother

% \newcommand*{\max}[1]{\begingroup\mathrm{max}\left(#1\right)\endgroup}
% \newcommand*{\min}[1]{\mathrm{min}\left(#1\right)}

\usepackage{enumitem}
% \setlist{nolistsep}
% \setitemize{labelindent=\parindent,leftmargin=*,align=left,itemindent=2em,noitemsep}%,leftmargin=*,topsep=2pt,partopsep=0pt}
\setitemize{leftmargin=0em,itemsep=0em,partopsep=0em,parsep=0em,topsep=0em,itemindent=2.3em,align=left}
\setenumerate{leftmargin=0em,itemsep=0em,partopsep=0em,parsep=0em,topsep=0em,itemindent=2.5em,align=left}


\renewcommand{\baselinestretch}{1.1}
\renewcommand*{\arraystretch}{1.5}

\usepackage{graphicx}%\resizebox
\graphicspath{{images/}} %Setting the graphicspath

\usepackage[makeroom]{cancel} % for xcancel/cancel/bcancel etc.

\usepackage{fancyvrb}           % for BVerbatim environment

\usepackage{verbatim}
% Center verbatim environment, with the help from verbatim package
\makeatletter
\def\verbatim@font{\normalfont\ttfamily\kai\Large
  \hyphenchar\font\m@ne
  \@noligs}
\makeatother
\newenvironment{pcontent}{%
  \par
  \centering
  \varwidth{\linewidth}%
  \verbatim
}{%
  \endverbatim
  \endvarwidth
  \par\vskip10pt
}

\newcommand{\ptitle}[1]{\par\vskip20pt{\centering\bfseries\kai\Large{#1}\par}\nopagebreak\vskip5pt\nopagebreak}
\newcommand{\pauthor}[1]{\par{\centering\kai【{#1}】\par}\nopagebreak\vskip10pt}
\newcommand{\premark}[1]{\par\kai\small【注释】{#1}\par\vskip5pt}
\newcommand{\ppreface}[1]{{\setlength{\parindent}{2em}\small\kai{#1}}\par\vskip5pt}

% \par indent
\usepackage{indentfirst}
% parindent to 2 characters
\setlength{\parindent}{2em}
\setlength{\parskip}{3pt}

\usepackage{ifthen}             % for \ifelsethen, \whiledo
% \ifthenelse{CONDITION}{POSITIVE}{NEGATIVE}
%     2 is an \ifthenelse{\isodd{2}}{ODD}{EVEN} number.
% \whiledo{CONDITION}{LOOP CONSTRUCT}
%     \newcounter{X}
%     \whiledo{\value{X}<10}{\value{X},\stepcounter{X}}

% 3 counters for loops
\newcounter{X}
\newcounter{Y}
\newcounter{Z}

% \include{myconfig}

\newcommand{\dx}{\mathrm{d}x}
\newcommand{\dy}{\mathrm{d}y}
% \newcommand{\dz}{\mathrm{d}z}


% comment this when compile the whole document
% \includeonly{proofs-without-words}
% \includeonly{golden-ratio}
% \includeonly{area}
% \includeonly{five-models}
% \includeonly{logic}
% \includeonly{geometry}
% \includeonly{graphs-of-functions}
% \includeonly{proofs-without-words}
% \includeonly{board-coverage}
% \includeonly{graphs}
% \includeonly{traps}
% \includeonly{intuition}
% \includeonly{algorithm}
\includeonly{magic-square}

\begin{document}

\frontmatter
\include{cover}

%% Remvoe the self reference of tableofcontents
\tableofcontents*
% \begin{KeepFromToc}
%   \tableofcontents
% \end{KeepFromToc}

\mainmatter
\include{introduction}
\include{number-theory}
\include{golden-ratio}
\include{numerical-method}
\include{induction}
\include{area}
\include{quadratic-equation}
\include{function}
\include{symetric}
\include{extreme}
\include{infinite-series}
\include{monotonic-functions}
\include{metric-space}
\include{fixed-point}
\include{identities}
\include{perfect_squares}
\include{pigeonhole}
\include{buffalo-way}
\include{basic-inequalities}
\include{pythagorean_triples}
\include{five-models}
\include{geometry}
\include{geometric-inequality}
\include{cauchy-schwarz}
\include{convex}
\include{minkowski}
\include{graphs-of-functions}

\include{proofs-without-words}
\include{board-coverage}
\include{graphs}

\include{insight}
\include{fun}
\include{methods}
\include{logic}

\include{magic-square}

\include{algorithm}

\include{intuition}
\include{traps}
\end{document}

